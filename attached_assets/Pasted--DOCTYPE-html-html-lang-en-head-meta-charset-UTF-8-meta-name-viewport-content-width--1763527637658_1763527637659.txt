<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Krittics Crew Command Center POC</title> <!-- Tailwind CSS CDN --> <script src="https://cdn.tailwindcss.com"></script> <!-- Inter Font --> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"> <style> body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6edf3; } .neon-border { border: 1px solid #00c0a8; box-shadow: 0 0 8px rgba(0, 192, 168, 0.6); } .neon-button { background-color: #00c0a8; color: #0d1117; transition: all 0.2s; } .neon-button:hover:not(:disabled) { background-color: #00e0c0; box-shadow: 0 0 10px rgba(0, 192, 168, 0.8); } .text-neon { color: #00c0a8; } .bg-card { background-color: #161b22; } .chat-container { height: 200px; } </style> </head> <body class="p-4 md:p-8"> <div id="loading" class="text-center mt-20 text-xl">Initializing Firebase and Signing In...</div> <div id="app" class="hidden max-w-4xl mx-auto"> <h1 class="text-3xl font-bold text-center mb-6 text-neon">Crew Command Center PoC</h1> <p id="user-id-display" class="text-center text-sm mb-6 text-gray-500"></p> <!-- Notification Message Box --> <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div> <!-- Crew Status Card --> <div id="crew-status-card" class="bg-card neon-border rounded-xl p-4 mb-8"> <h2 class="text-xl font-semibold mb-3">Crew Session Status</h2> <div id="crew-status">No active crew.</div> </div> <!-- Video and Chat Section (Hidden until crew is active) --> <div id="crew-active-section" class="hidden"> <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"> <!-- Video Player Simulation --> <div class="bg-card neon-border rounded-xl p-4"> <h2 class="text-xl font-semibold mb-2">Simulated Video Player (Master: <span id="master-user-display" class="font-mono text-xs"></span>)</h2> <div id="video-display" class="bg-gray-800 aspect-video rounded-lg flex items-center justify-center text-3xl font-bold text-gray-400 mb-4"> Video is Paused (0.00s) </div> <div class="flex space-x-2"> <button id="play-button" onclick="syncVideo('play')" class="neon-button px-4 py-2 rounded-lg flex-1">▶️ Play</button> <button id="pause-button" onclick="syncVideo('pause')" class="neon-button px-4 py-2 rounded-lg flex-1">⏸️ Pause</button> <button onclick="syncVideo('seek')" class="neon-button px-4 py-2 rounded-lg">⏩ Seek to 30s</button> </div> <p class="text-xs mt-2 text-gray-400">Only the Crew Master can control playback.</p> </div> <!-- Crew Chat --> <div class="bg-card neon-border rounded-xl p-4"> <h2 class="text-xl font-semibold mb-2">Crew Chat</h2> <div id="chat-messages" class="chat-container overflow-y-auto p-2 bg-gray-900 rounded-lg mb-3"> <!-- Chat messages go here --> </div> <div class="flex space-x-2"> <input type="text" id="chat-input" class="flex-1 p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="Say something to the crew..." /> <button id="send-chat-button" onclick="sendChatMessage()" class="neon-button px-4 py-2 rounded-lg">Send</button> </div> </div> </div> </div> <!-- Crew Creation / Friend Management Section (Visible when no crew is active) --> <div id="crew-setup-section"> <h2 class="text-2xl font-bold mt-10 mb-4">Create New Crew</h2> <!-- Friend List Search --> <div class="mb-4"> <input type="text" id="friend-search" oninput="filterFriends()" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="Search friends by username..." /> </div> <!-- Friend List and Crew Selection --> <div class="bg-card neon-border rounded-xl p-4"> <h3 class="text-lg font-semibold mb-3">Select Crew Members (Up to 3):</h3> <div id="friend-list" class="space-y-2"> <!-- Friends loaded here --> <p class="text-gray-500 italic">No friends found. Use the "Add Friend" form below.</p> </div> <button id="create-crew-button" onclick="createCrew()" disabled class="neon-button w-full mt-4 py-3 rounded-lg disabled:opacity-50"> Generate Crew Call (0 Selected) </button> <!-- Join Room is intentionally disabled as requested --> <button class="neon-button w-full mt-2 py-3 rounded-lg opacity-50 cursor-not-allowed" disabled> Join Room (Disabled for PoC) </button> </div> <!-- Add Friend Form --> <h2 class="text-2xl font-bold mt-10 mb-4">Add Friend (PoC)</h2> <div class="bg-card neon-border rounded-xl p-4 flex space-x-2"> <input type="text" id="friend-id-input" class="flex-1 p-2 rounded-lg bg-gray-800 border border-gray-700 text-white" placeholder="Enter Friend's User ID (e.g., A4zY)" /> <button onclick="addFriendPoc()" class="neon-button px-4 py-2 rounded-lg">Add Friend</button> </div> </div> </div> <!-- Firebase SDK Imports and Logic --> <script type="module"> import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, arrayUnion, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; setLogLevel('debug'); // Enable detailed Firebase logging let app; let db; let auth; let userId; let username = "Unknown User"; // Default username for PoC // --- Global State --- let friends = []; let selectedFriends = new Set(); let activeCrewId = null; let activeCrew = null; let chatUnsubscribe = null; let syncUnsubscribe = null; // --- DOM Elements --- const $loading = document.getElementById('loading'); const $app = document.getElementById('app'); const $userIdDisplay = document.getElementById('user-id-display'); const $messageBox = document.getElementById('message-box'); const $friendList = document.getElementById('friend-list'); const $createCrewButton = document.getElementById('create-crew-button'); const $crewSetupSection = document.getElementById('crew-setup-section'); const $crewActiveSection = document.getElementById('crew-active-section'); const $crewStatus = document.getElementById('crew-status'); const $chatMessages = document.getElementById('chat-messages'); const $masterUserDisplay = document.getElementById('master-user-display'); const $videoDisplay = document.getElementById('video-display'); // --- Utility Functions --- function displayMessage(message, isError = false) { $messageBox.textContent = message; $messageBox.className = `p-3 mb-4 rounded-lg text-sm ${isError ? 'bg-red-900 text-red-300 neon-border' : 'bg-green-900 text-green-300 neon-border'} block`; setTimeout(() => { $messageBox.classList.add('hidden'); }, 5000); } // --- Core Firebase Setup --- async function initFirebaseAndAuth() { try { // Initialize Firebase using the global config const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); // Sign In using custom token or anonymously if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } auth.onAuthStateChanged(async (user) => { if (user) { userId = user.uid; // Set a placeholder username for this PoC username = `User-${userId.substring(0, 4)}`; $userIdDisplay.textContent = `User ID: ${userId} | Username: ${username}`; $loading.classList.add('hidden'); $app.classList.remove('hidden'); // Ensure user profile exists (for friend list) await setDoc(doc(db, 'artifacts', 'krittics-app-id', 'users', userId), { uid: userId, username: username, last_online: serverTimestamp(), friends: {}, // Map of friend UIDs current_crew_id: null }, { merge: true }); watchFriendsList(); watchActiveCrew(); } else { displayMessage("Authentication failed. Please check Firebase configuration.", true); } }); } catch (error) { console.error("Firebase initialization or auth error:", error); $loading.textContent = `Error initializing: ${error.message}`; $loading.classList.remove('hidden'); $app.classList.add('hidden'); } } // --- Friend Management Logic --- // PoC function to simulate adding a friend and updating their 'times_crewed' window.addFriendPoc = async function() { const friendId = document.getElementById('friend-id-input').value.trim(); if (!friendId || friendId === userId) { displayMessage("Enter a valid Friend ID that is not your own.", true); return; } try { // 1. Add friend to the current user's list await updateDoc(doc(db, 'artifacts', 'krittics-app-id', 'users', userId), { [`friends.${friendId}`]: { status: 'accepted', times_crewed: Math.floor(Math.random() * 10) + 1, // Start with a random count last_crewed: serverTimestamp() } }); // 2. Add current user to the friend's list (for reciprocal relationship) await updateDoc(doc(db, 'artifacts', 'krittics-app-id', 'users', friendId), { [`friends.${userId}`]: { status: 'accepted', times_crewed: Math.floor(Math.random() * 5) + 1, last_crewed: serverTimestamp() } }); document.getElementById('friend-id-input').value = ''; displayMessage(`Successfully added friend with ID: ${friendId}. Refreshing list...`); } catch (e) { console.error("Error adding friend:", e); displayMessage(`Error adding friend: ${e.message}`, true); } } // Real-time listener for the friends list function watchFriendsList() { const userDocRef = doc(db, 'artifacts', 'krittics-app-id', 'users', userId); onSnapshot(userDocRef, (docSnap) => { if (docSnap.exists() && docSnap.data().friends) { const friendMap = docSnap.data().friends; friends = Object.entries(friendMap) .filter(([id, data]) => data.status === 'accepted') .map(([id, data]) => ({ id, username: `User-${id.substring(0, 4)}`, times_crewed: data.times_crewed || 0, last_crewed: data.last_crewed ? data.last_crewed.toDate() : new Date(0) })) .sort((a, b) => { // Primary sort: times_crewed (descending) if (b.times_crewed !== a.times_crewed) { return b.times_crewed - a.times_crewed; } // Secondary sort: last_crewed (descending) return b.last_crewed.getTime() - a.last_crewed.getTime(); }); renderFriendsList(friends); } else { friends = []; renderFriendsList([]); } }); } function renderFriendsList(friendData) { const filterText = document.getElementById('friend-search').value.toLowerCase(); const filteredFriends = friendData.filter(f => f.username.toLowerCase().includes(filterText)); if (filteredFriends.length === 0) { $friendList.innerHTML = `<p class="text-gray-500 italic">No friends found or match your search.</p>`; $createCrewButton.disabled = true; return; } $friendList.innerHTML = filteredFriends.map(friend => ` <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg"> <div class="flex-1"> <span class="font-semibold">${friend.username}</span> <span class="text-xs text-gray-400 ml-2">(Creweed: ${friend.times_crewed})</span> </div> <label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" data-friend-id="${friend.id}" onchange="toggleFriendSelection(this)" class="sr-only peer"> <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-neon"></div> </label> </div> `).join(''); // Restore selection state after re-render selectedFriends.forEach(id => { const checkbox = $friendList.querySelector(`input[data-friend-id="${id}"]`); if (checkbox) checkbox.checked = true; }); updateCreateCrewButton(); } window.filterFriends = function() { renderFriendsList(friends); } window.toggleFriendSelection = function(checkbox) { const friendId = checkbox.dataset.friendId; if (checkbox.checked) { if (selectedFriends.size >= 3) { checkbox.checked = false; // Limit to 3 friends + host displayMessage("Crew size limit reached (Host + 3 Friends max).", true); return; } selectedFriends.add(friendId); } else { selectedFriends.delete(friendId); } updateCreateCrewButton(); } function updateCreateCrewButton() { const count = selectedFriends.size; $createCrewButton.textContent = `Generate Crew Call (${count} Selected)`; $createCrewButton.disabled = count === 0; } // --- Crew Session Logic --- // Generates a short, user-friendly room code (PoC - not collision-safe) function generateRoomCode() { return Math.random().toString(36).substring(2, 7).toUpperCase(); } window.createCrew = async function() { if (activeCrewId) { displayMessage("You are already in an active crew!", true); return; } const code = generateRoomCode(); const members = {}; selectedFriends.forEach(id => members[id] = true); members[userId] = true; // Add host try { // Create the Crew document const crewDocRef = doc(db, 'artifacts', 'krittics-app-id', 'public', 'data', 'crews', code); await setDoc(crewDocRef, { movie_id: 'sample-movie-id-123', movie_name: 'The Sync Test', owner_id: userId, owner_username: username, members: members, created_at: serverTimestamp(), playback_state: 'pause', current_time: 0, last_updated_at: serverTimestamp() }); // Update all members' status for (const memberId of Object.keys(members)) { await updateDoc(doc(db, 'artifacts', 'krittics-app-id', 'users', memberId), { current_crew_id: code }); } activeCrewId = code; displayMessage(`Crew created! Share code: ${code}`); } catch (e) { console.error("Error creating crew:", e); displayMessage(`Error creating crew: ${e.message}`, true); } } // Listener to watch if the current user is part of a crew function watchActiveCrew() { const userDocRef = doc(db, 'artifacts', 'krittics-app-id', 'users', userId); onSnapshot(userDocRef, (docSnap) => { const crewId = docSnap.data()?.current_crew_id; // Handle transition out of a crew if (!crewId && activeCrewId) { activeCrewId = null; activeCrew = null; if (chatUnsubscribe) chatUnsubscribe(); if (syncUnsubscribe) syncUnsubscribe(); $crewSetupSection.classList.remove('hidden'); $crewActiveSection.classList.add('hidden'); $crewStatus.textContent = 'No active crew.'; displayMessage("You have left the crew session."); return; } // Handle transition into a new crew if (crewId && crewId !== activeCrewId) { activeCrewId = crewId; $crewSetupSection.classList.add('hidden'); $crewActiveSection.classList.remove('hidden'); watchCrewData(crewId); watchChat(crewId); } }); } // Listener for the active crew's data (including sync state) function watchCrewData(crewId) { if (syncUnsubscribe) syncUnsubscribe(); const crewDocRef = doc(db, 'artifacts', 'krittics-app-id', 'public', 'data', 'crews', crewId); syncUnsubscribe = onSnapshot(crewDocRef, (docSnap) => { if (!docSnap.exists()) { displayMessage("Active crew session ended.", true); // Force leave crew updateDoc(doc(db, 'artifacts', 'krittics-app-id', 'users', userId), { current_crew_id: null }); return; } activeCrew = docSnap.data(); // Update Crew Status Display const isHost = activeCrew.owner_id === userId; const statusText = isHost ? 'Crew Host' : 'Crew Member'; $crewStatus.innerHTML = `**Status:** <span class="text-neon">${statusText}</span> (Code: ${crewId}) watching **${activeCrew.movie_name}**.`; $masterUserDisplay.textContent = activeCrew.owner_username; // Update Video Player State const state = activeCrew.playback_state; const time = activeCrew.current_time; const displayTime = time.toFixed(2); $videoDisplay.textContent = `Video is ${state.toUpperCase()} (${displayTime}s)`; // Enable/Disable controls based on host status document.getElementById('play-button').disabled = !isHost; document.getElementById('pause-button').disabled = !isHost; if (!isHost) { // Logic for slave clients: Execute the command // In a real app, Video.js would execute play/pause/seek here. displayMessage(`Sync Update: ${activeCrew.owner_username} set player to ${state} at ${displayTime}s`); } }); } // Function for the Host to send a command to the database window.syncVideo = async function(command) { if (!activeCrew || activeCrew.owner_id !== userId) { displayMessage("Only the Crew Master (Host) can control playback.", true); return; } let newState = { playback_state: activeCrew.playback_state, current_time: activeCrew.current_time }; if (command === 'play') { newState.playback_state = 'play'; } else if (command === 'pause') { newState.playback_state = 'pause'; } else if (command === 'seek') { // PoC seek to a specific time newState.current_time = 30.00; newState.playback_state = 'pause'; // Typically pause on seek } try { const crewDocRef = doc(db, 'artifacts', 'krittics-app-id', 'public', 'data', 'crews', activeCrewId); await updateDoc(crewDocRef, { playback_state: newState.playback_state, current_time: newState.current_time, last_updated_at: serverTimestamp() }); displayMessage(`Host command sent: ${newState.playback_state} at ${newState.current_time.toFixed(2)}s`); } catch (e) { console.error("Error syncing video:", e); displayMessage(`Error syncing video: ${e.message}`, true); } } // --- Chat Logic --- window.sendChatMessage = async function() { const $input = document.getElementById('chat-input'); const text = $input.value.trim(); if (!text || !activeCrewId) return; try { const chatCollectionRef = collection(db, 'artifacts', 'krittics-app-id', 'public', 'data', 'crews', activeCrewId, 'chatMessages'); await setDoc(doc(chatCollectionRef), { sender_id: userId, sender_username: username, text: text, timestamp: serverTimestamp() }); $input.value = ''; } catch (e) { console.error("Error sending message:", e); displayMessage(`Error sending message: ${e.message}`, true); } } function watchChat(crewId) { if (chatUnsubscribe) chatUnsubscribe(); const chatCollectionRef = collection(db, 'artifacts', 'krittics-app-id', 'public', 'data', 'crews', crewId, 'chatMessages'); const q = query(chatCollectionRef, where("timestamp", ">", new Date(Date.now() - 3600000))); // Only last hour chatUnsubscribe = onSnapshot(chatCollectionRef, (snapshot) => { snapshot.docChanges().forEach(change => { if (change.type === "added") { const message = change.doc.data(); renderChatMessage(message); } }); $chatMessages.scrollTop = $chatMessages.scrollHeight; // Auto-scroll }); } function renderChatMessage(message) { const isMe = message.sender_id === userId; const messageElement = document.createElement('div'); messageElement.className = `p-1 text-sm ${isMe ? 'text-right' : 'text-left'}`; const senderName = isMe ? 'You' : message.sender_username; const nameClass = isMe ? 'text-blue-400' : 'text-neon'; messageElement.innerHTML = ` <span class="${nameClass} font-semibold">${senderName}:</span> ${message.text} `; $chatMessages.appendChild(messageElement); } // --- Execute Initialization --- initFirebaseAndAuth(); </script> </body> </html>