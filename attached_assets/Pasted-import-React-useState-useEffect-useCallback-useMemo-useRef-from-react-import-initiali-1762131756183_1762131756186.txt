import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged 
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    doc, 
    onSnapshot, 
    query, 
    setDoc, 
    serverTimestamp, 
    limit,
    updateDoc, 
    arrayUnion,
    deleteDoc, 
    arrayRemove,
    addDoc, 
    orderBy 
} from 'firebase/firestore';

// --- Global Context Variables (Mandatory for Canvas Environment) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'krittics-platform';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// ------------------------------------------------------------------

// Utility to handle exponential backoff for API calls
const withBackoff = async (fn, retries = 5, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (i === retries - 1) throw error;
            console.warn(`API call failed, retrying in ${delay * Math.pow(2, i)}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
        }
    }
};

/**
 * Simulates the Deep Dive Trivia Generation using the Gemini API.
 */
const generateTrivia = async (movieTitle, setIsGenerating, setTriviaError) => {
    setIsGenerating(true);
    setTriviaError(null);
    try {
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const systemPrompt = `You are the Krittics Deep Dive Trivia Generator. Your task is to create 5 unique, engaging, spoiler-free trivia questions focused on plot details, memorable quotes, characters, or behind-the-scenes facts for the movie: "${movieTitle}". Ensure there is only one correct answer per question. The response must be a valid JSON array matching the provided schema.`;

        const userQuery = `Generate 5 Deep Dive Trivia questions for the movie "${movieTitle}".`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            // Use Google Search grounding to help generate accurate facts
            tools: [{ "google_search": {} }], 
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    description: "An array of trivia question objects.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            question: { type: "STRING", description: "The trivia question." },
                            options: { 
                                type: "ARRAY", 
                                description: "Four multiple-choice options, including the correct answer.", 
                                items: { type: "STRING" } 
                            },
                            correctAnswer: { type: "STRING", description: "The text of the correct option." }
                        },
                        required: ["question", "options", "correctAnswer"]
                    }
                }
            }
        };

        const response = await withBackoff(() => fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }));

        if (!response.ok) {
            throw new Error(`API Request failed with status: ${response.status}`);
        }

        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (jsonText) {
            const parsedTrivia = JSON.parse(jsonText);
            return parsedTrivia;
        } else {
            throw new Error("No trivia content was generated by the model.");
        }

    } catch (e) {
        console.error("Trivia generation error:", e);
        setTriviaError("Failed to generate trivia. Please try again or check API key/service status.");
        return [];
    } finally {
        setIsGenerating(false);
    }
};

// --- Firebase Components ---

/**
 * Initializes Firebase, authenticates the user, and sets up auth listeners.
 */
const useFirebaseInit = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
             console.error("Firebase config is missing. Data persistence will not work.");
             // Fallback to anonymous local ID if config is missing
             setUserId(crypto.randomUUID());
             setIsAuthReady(true);
             return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authService = getAuth(app);
            setDb(firestore);
            setAuth(authService);
            
            // Log Firestore Debug
            import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js')
                .then(mod => mod.setLogLevel('debug'));

            // 1. Initial Authentication
            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(authService, initialAuthToken);
                    } else {
                        await signInAnonymously(authService);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // Fallback in case of auth failure
                    setUserId(crypto.randomUUID());
                    setIsAuthReady(true);
                }
            };
            authenticate();

            // 2. Auth State Listener
            const unsubscribe = onAuthStateChanged(authService, (user) => {
                const currentId = user?.uid || crypto.randomUUID();
                setUserId(currentId);
                setIsAuthReady(true);
                console.log("Auth state changed. User ID:", currentId);
            });

            return () => unsubscribe();

        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    }, []);

    return { db, auth, userId, isAuthReady };
};

// --- Header Component (Updated) ---

const Header = ({ currentPage, setCurrentPage, userId }) => (
    <div className="flex justify-between items-center p-4 bg-gray-900 shadow-lg text-white">
        <h1 className="text-3xl font-extrabold text-blue-400 tracking-wider cursor-pointer" onClick={() => setCurrentPage('home')}>
            Krittics
        </h1>
        <div className="flex space-x-6">
            <button
                onClick={() => setCurrentPage('home')}
                className={`text-lg font-medium transition duration-200 ${
                    currentPage === 'home' ? 'text-white border-b-2 border-blue-400' : 'text-gray-400 hover:text-white'
                }`}
            >
                Movie Player
            </button>
            <button
                onClick={() => setCurrentPage('library')}
                className={`text-lg font-medium transition duration-200 ${
                    currentPage === 'library' ? 'text-white border-b-2 border-blue-400' : 'text-gray-400 hover:text-white'
                }`}
            >
                Library
            </button>
            <button
                onClick={() => setCurrentPage('krossfire')}
                className={`flex items-center text-lg font-medium transition duration-200 ${
                    currentPage === 'krossfire' ? 'text-white border-b-2 border-red-400' : 'text-gray-400 hover:text-white'
                }`}
            >
                {/* Lightning Bolt Icon (Now Outline) */}
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    className="h-5 w-5 mr-1 text-yellow-400 stroke-current" 
                    fill="none" 
                    viewBox="0 0 24 24" 
                    strokeWidth="2"
                >
                    <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                </svg>
                Krittics Krossfire
            </button>
        </div>
        <span className="text-sm text-gray-500 hidden md:block">
            User ID: <span className="text-blue-400 font-mono">{userId ? userId.substring(0, 8) + '...' : 'Loading...'}</span>
        </span>
    </div>
);

// --- Deep Dive Trivia Component ---

const TriviaGame = ({ db, userId, isAuthReady }) => {
    const [trivia, setTrivia] = useState([]);
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [score, setScore] = useState(0);
    const [gameStatus, setGameStatus] = useState('initial'); // 'initial', 'playing', 'finished'
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [selectedAnswer, setSelectedAnswer] = useState(null);
    const [isCorrect, setIsCorrect] = useState(null);

    const movieTitle = "The Grand Adventure of Elias"; // Mock movie title for generation

    const fetchTrivia = useCallback(async () => {
        const generatedTrivia = await generateTrivia(movieTitle, setLoading, setError);
        if (generatedTrivia.length > 0) {
            setTrivia(generatedTrivia);
            setGameStatus('playing');
            setScore(0);
            setCurrentQuestionIndex(0);
        }
    }, [movieTitle]);

    useEffect(() => {
        // Automatically start fetching trivia once auth is ready (simulating post-credits roll)
        if (isAuthReady && gameStatus === 'initial') {
            // fetchTrivia(); // Uncomment this line to auto-start generation on load
        }
    }, [isAuthReady]);

    const handleAnswer = (option) => {
        if (selectedAnswer) return; // Prevent double clicking

        setSelectedAnswer(option);
        const question = trivia[currentQuestionIndex];
        const correct = option === question.correctAnswer;
        setIsCorrect(correct);

        if (correct) {
            setScore(s => s + 1);
        }

        setTimeout(() => {
            if (currentQuestionIndex < trivia.length - 1) {
                setCurrentQuestionIndex(currentQuestionIndex + 1);
                setSelectedAnswer(null);
                setIsCorrect(null);
            } else {
                setGameStatus('finished');
            }
        }, 1500); // 1.5 second delay before next question
    };

    const currentQuestion = trivia[currentQuestionIndex];

    if (loading) {
        return (
            <div className="text-center p-8 bg-gray-800 rounded-xl">
                <p className="text-blue-400 text-xl font-semibold animate-pulse">
                    Generating Deep Dive Trivia for "{movieTitle}"...
                </p>
                <p className="text-gray-400 mt-2">
                    (Simulating LLM call for Custom Content. May take a few seconds.)
                </p>
            </div>
        );
    }

    if (error) {
        return (
            <div className="p-6 bg-red-900/50 border border-red-500 rounded-xl text-red-200">
                <p className="font-bold">Trivia Error:</p>
                <p>{error}</p>
                <button 
                    onClick={fetchTrivia}
                    className="mt-4 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition"
                >
                    Try Generating Again
                </button>
            </div>
        );
    }

    if (gameStatus === 'initial') {
        return (
            <div className="text-center p-8 bg-gray-800 rounded-xl">
                <h3 className="text-2xl text-white font-bold mb-4">
                    End-of-Movie Deep Dive Trivia Ready!
                </h3>
                <p className="text-gray-400 mb-6">
                    Test your recall on **{movieTitle}**'s plot, quotes, and facts.
                </p>
                <button
                    onClick={fetchTrivia}
                    className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition transform hover:scale-105"
                >
                    Start Trivia Now
                </button>
            </div>
        );
    }

    if (gameStatus === 'finished') {
        const percentage = Math.round((score / trivia.length) * 100);
        return (
            <div className="text-center p-8 bg-gray-800 rounded-xl">
                <h3 className="text-3xl text-blue-400 font-extrabold mb-4">
                    Scorecard: Movie Master Status!
                </h3>
                <p className="text-5xl font-black text-white mb-6">
                    {score} / {trivia.length}
                </p>
                <p className="text-xl text-gray-300 mb-8">
                    That's **{percentage}%** accuracy on **{movieTitle}** trivia!
                </p>
                <button
                    onClick={() => setGameStatus('initial')}
                    className="px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition transform hover:scale-105"
                >
                    Play Again
                </button>
            </div>
        );
    }
    
    // Game is 'playing'
    return (
        <div className="p-6 bg-gray-800 rounded-xl shadow-2xl">
            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h4 className="text-xl font-bold text-white">
                    Question {currentQuestionIndex + 1} of {trivia.length}
                </h4>
                <div className="text-2xl font-black text-blue-400">
                    Score: {score}
                </div>
            </div>

            {currentQuestion && (
                <>
                    <p className="text-2xl font-semibold text-gray-100 mb-6">
                        {currentQuestion.question}
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {currentQuestion.options.map((option, index) => {
                            let optionClass = 'bg-gray-700 hover:bg-gray-600';
                            if (selectedAnswer) {
                                if (option === currentQuestion.correctAnswer) {
                                    optionClass = 'bg-green-600/80 shadow-green-500/50';
                                } else if (option === selectedAnswer) {
                                    optionClass = 'bg-red-600/80 shadow-red-500/50';
                                } else {
                                    optionClass = 'bg-gray-700 opacity-50 cursor-not-allowed';
                                }
                            }
                            
                            return (
                                <button
                                    key={index}
                                    onClick={() => handleAnswer(option)}
                                    disabled={!!selectedAnswer}
                                    className={`p-4 text-left text-white font-medium rounded-xl transition duration-300 transform shadow-md ${optionClass} ${
                                        !selectedAnswer ? 'hover:scale-[1.02]' : ''
                                    }`}
                                >
                                    {option}
                                </button>
                            );
                        })}
                    </div>
                    {selectedAnswer && (
                        <p className={`mt-4 text-center text-xl font-bold ${isCorrect ? 'text-green-400' : 'text-red-400'}`}>
                            {isCorrect ? 'Correct! ðŸŽ‰' : `Incorrect. The answer was: ${currentQuestion.correctAnswer}`}
                        </p>
                    )}
                </>
            )}
        </div>
    );
};

// --- Krittics Krossfire (Competitive) Component ---

const Krossfire = ({ db, userId, isAuthReady }) => {
    const [leaderboard, setLeaderboard] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const leaderboardPath = useMemo(() => `/artifacts/${appId}/public/data/leaderboard`, []);

    // 1. Fetch Leaderboard in Real-Time
    useEffect(() => {
        if (!db || !isAuthReady) return;

        setIsLoading(true);
        try {
            const q = query(
                collection(db, leaderboardPath),
                // Note: Firestore doesn't allow ordering by score without an index, 
                // so we fetch and sort in memory for simplicity/robustness.
                limit(10)
            );

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const results = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort by score in memory (highest first)
                results.sort((a, b) => b.score - a.score); 
                
                setLeaderboard(results);
                setIsLoading(false);
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                setIsLoading(false);
            });

            return () => unsubscribe();
        } catch (e) {
            console.error("Firestore error setting up snapshot:", e);
            setIsLoading(false);
        }
    }, [db, isAuthReady, leaderboardPath]);

    // 2. Simulate Score Submission
    const handleScoreSubmit = async () => {
        if (!db || !userId) return;

        const newScore = Math.floor(Math.random() * 500) + 500; // Random competitive score
        const userName = `Krittic-${userId.substring(0, 4)}`;
        const docRef = doc(db, leaderboardPath, userId); // Use userId as doc ID for simplicity

        try {
            await setDoc(docRef, {
                userId: userId,
                userName: userName,
                score: newScore,
                lastUpdated: serverTimestamp()
            }, { merge: true }); // Use merge so we don't overwrite if user exists
            
            console.log(`Submitted score ${newScore} for user ${userName}`);
        } catch (e) {
            console.error("Error submitting score:", e);
        }
    };
    
    const currentUserScore = leaderboard.find(entry => entry.userId === userId);

    return (
        <div className="bg-gray-900 min-h-[80vh] p-8 rounded-xl shadow-2xl">
            <h2 className="text-4xl font-extrabold text-red-500 mb-2 border-b-4 border-red-700 pb-2">
                Krittics Krossfire <span className="text-xl text-gray-400">| National Competitive Trivia</span>
            </h2>
            <p className="text-gray-400 mb-6">
                Test your film expertise against other players all over the US.
            </p>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                 <div className="col-span-1 md:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 className="text-2xl font-bold text-white mb-4">
                        Themed Tournaments
                    </h3>
                    <p className="text-red-300 font-semibold mb-4">
                        MARVEL CINEMATIC MAYHEM - Live in 10 minutes!
                    </p>
                    <p className="text-gray-300">
                        Fast-paced, real-time battles rewarding accuracy and speed. Win virtual badges and bragging rights.
                    </p>
                    
                    <button
                        onClick={handleScoreSubmit}
                        className="mt-6 px-6 py-3 bg-red-600 text-white font-bold rounded-xl shadow-xl hover:bg-red-700 transition transform hover:scale-105"
                        disabled={!isAuthReady}
                    >
                        {currentUserScore ? 'Compete Again! (Simulate Score)' : 'Join Match (Simulate Score)'}
                    </button>
                    {
                        currentUserScore && (
                             <p className="text-green-400 mt-3 text-sm">
                                Your current highest score: **{currentUserScore.score}**
                            </p>
                        )
                    }

                </div>
                <div className="col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col justify-center items-center text-center">
                    <p className="text-3xl font-extrabold text-blue-400">
                        {leaderboard.length}
                    </p>
                    <p className="text-lg text-gray-400">
                        Top Krittics on the National Leaderboard
                    </p>
                    <p className="text-sm text-gray-500 mt-2">
                         Your ID: <span className="font-mono">{userId}</span>
                    </p>
                </div>
            </div>

            <h3 className="text-3xl font-bold text-white mb-4">
                National Leaderboards
            </h3>
            
            {isLoading && <p className="text-blue-400 animate-pulse">Loading Leaderboard Data...</p>}
            
            <div className="bg-gray-800 rounded-lg overflow-hidden">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-700">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rank</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Krittic Name</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Score</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-700">
                        {leaderboard.map((entry, index) => (
                            <tr key={entry.id} className={entry.userId === userId ? 'bg-red-900/40 font-bold' : 'hover:bg-gray-700 transition'}>
                                <td className="px-6 py-4 whitespace-nowrap text-lg text-red-500">
                                    #{index + 1}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-white">
                                    {entry.userName}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-white">
                                    {entry.score.toLocaleString()}
                                </td>
                            </tr>
                        ))}
                        {leaderboard.length === 0 && !isLoading && (
                            <tr>
                                <td colSpan="3" className="px-6 py-4 text-center text-gray-500">
                                    No scores yet. Be the first to play!
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// --- Utility Function for Room Codes ---
const generateRoomCode = () => {
    // Generate a simple, uppercase, 6-character code
    return Math.random().toString(36).substring(2, 8).toUpperCase();
};

// --- PrivateRooms Component (New Feature) ---

const PrivateRooms = ({ db, userId, isAuthReady, setCurrentPage }) => {
    const [roomCode, setRoomCode] = useState('');
    const [currentRoom, setCurrentRoom] = useState(null); // The room the user is currently in
    const [joinInput, setJoinInput] = useState('');
    const [statusMessage, setStatusMessage] = useState('');
    const [messages, setMessages] = useState([]); // State for chat messages
    const [newMessage, setNewMessage] = useState('');
    const messagesEndRef = useRef(null); // Ref for scrolling to bottom of chat
    
    // NOTE: This assumes appId is available from the global context variables initialized at the top of App.jsx
    const roomsCollectionPath = useMemo(() => `/artifacts/${appId}/public/data/rooms`, []);

    // 1. Real-time listener for the current room
    useEffect(() => {
        if (!db || !isAuthReady || !roomCode) return;

        const roomRef = doc(db, roomsCollectionPath, roomCode);
        const unsubscribe = onSnapshot(roomRef, (docSnap) => {
            if (docSnap.exists()) {
                const roomData = docSnap.data();
                // Check if the current user is still a member
                if (roomData.members.includes(userId)) {
                    setCurrentRoom(roomData);
                    setStatusMessage(`Joined room: ${roomData.roomName}`);
                } else {
                    // User was kicked or left
                    setCurrentRoom(null);
                    setRoomCode('');
                    setStatusMessage('You have left or been removed from the room.');
                }
            } else {
                // Room was deleted
                setCurrentRoom(null);
                setRoomCode('');
                setStatusMessage('The room you were in no longer exists.');
            }
        }, (error) => {
            console.error("Error fetching room data:", error);
            setStatusMessage('Error connecting to room.');
        });

        return () => unsubscribe();
    }, [db, isAuthReady, roomCode, roomsCollectionPath, userId]);
    
    // 2. Real-time listener for chat messages
    useEffect(() => {
        if (!db || !currentRoom) {
            setMessages([]);
            return;
        }

        // Collection path for messages is nested inside the room document
        const messagesCollectionPath = `${roomsCollectionPath}/${currentRoom.roomCode}/messages`;
        
        // Query to get all messages, ordered by timestamp
        const q = query(
            collection(db, messagesCollectionPath),
            orderBy('timestamp', 'asc') 
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const msgs = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setMessages(msgs);
        }, (error) => {
            console.error("Error fetching messages:", error);
        });

        return () => unsubscribe();
    }, [db, currentRoom, roomsCollectionPath]);
    
    // 3. Scroll to bottom of chat when new messages arrive
    useEffect(() => {
        if (messagesEndRef.current) {
            messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
    }, [messages]);


    // 4. Send Message Logic
    const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!db || !userId || !currentRoom || newMessage.trim() === '') return;

        const messagesCollectionPath = `${roomsCollectionPath}/${currentRoom.roomCode}/messages`;
        
        try {
            await addDoc(collection(db, messagesCollectionPath), {
                userId: userId,
                userName: `Krittic-${userId.substring(0, 4)}`,
                text: newMessage.trim(),
                timestamp: serverTimestamp(),
            });

            setNewMessage('');
        } catch (e) {
            console.error("Error sending message:", e);
        }
    };


    // 5. Room Creation Logic
    const handleCreateRoom = async () => {
        if (!db || !userId) {
            setStatusMessage('Authentication not ready.');
            return;
        }

        const newCode = generateRoomCode();
        const roomName = `Private Room by Krittic-${userId.substring(0, 4)}`;
        const roomRef = doc(db, roomsCollectionPath, newCode);

        try {
            await setDoc(roomRef, {
                roomCode: newCode,
                roomName: roomName,
                hostId: userId,
                movieTitle: 'Movie Selection Pending...', // Placeholder for future feature
                members: [userId],
                status: 'lobby',
                createdAt: serverTimestamp(),
            });

            setRoomCode(newCode);
            setStatusMessage(`Room created! Share code: ${newCode}`);

        } catch (e) {
            console.error("Error creating room:", e);
            setStatusMessage('Failed to create room.');
        }
    };

    // 6. Room Joining Logic
    const handleJoinRoom = async () => {
        if (!db || !userId || !joinInput) {
            setStatusMessage('Please enter a room code.');
            return;
        }
        
        const code = joinInput.toUpperCase().trim();
        const roomRef = doc(db, roomsCollectionPath, code);

        try {
            // Attempt to add user to the room's members array
            await updateDoc(roomRef, {
                members: arrayUnion(userId) // Add current user to members list
            });
            
            setRoomCode(code);
            setJoinInput('');
            setStatusMessage(`Successfully joined room ${code}.`);

        } catch (e) {
            // This catch block handles errors like "No document to update" if the code is invalid
            console.error("Error joining room:", e);
            setStatusMessage(`Failed to join room ${code}. Check the code and try again.`);
        }
    };
    
    // 7. Leaving/Deleting Room Logic
    const handleLeaveRoom = async () => {
        if (!db || !currentRoom) return;

        const roomRef = doc(db, roomsCollectionPath, currentRoom.roomCode);

        if (currentRoom.hostId === userId) {
            // If host, delete the entire room
            try {
                await deleteDoc(roomRef);
                setStatusMessage(`Room ${currentRoom.roomCode} deleted.`);
            } catch (e) {
                console.error("Error deleting room:", e);
                setStatusMessage('Failed to delete room.');
            }
        } else {
            // If member, just remove user from members array
            try {
                await updateDoc(roomRef, {
                    members: arrayRemove(userId)
                });
                setStatusMessage(`You left room ${currentRoom.roomCode}.`);
            } catch (e) {
                console.error("Error leaving room:", e);
                setStatusMessage('Failed to leave room.');
            }
        }
        
        // Reset local state
        setCurrentRoom(null);
        setRoomCode('');
        setMessages([]);
        
        // Navigate back to the main home page after leaving/deleting
        setCurrentPage('home');
    };

    if (!isAuthReady) {
        return <p className="text-blue-400">Loading user authentication...</p>;
    }
    
    if (currentRoom) {
        // --- Room Lobby Display with Chat ---
        const isHost = currentRoom.hostId === userId;
        
        return (
            <div className="bg-gray-900 p-8 rounded-xl shadow-2xl min-h-[80vh] grid grid-cols-1 lg:grid-cols-3 gap-8 text-white">
                {/* Column 1 & 2: Room Info, Video, and Chat */}
                <div className="lg:col-span-2">
                    <h2 className="text-4xl font-extrabold text-blue-400 mb-2">
                        {currentRoom.roomName}
                    </h2>
                    <p className="text-xl font-mono text-white mb-4 p-2 bg-gray-800/50 inline-block rounded-lg">
                        Code: {currentRoom.roomCode}
                    </p>
                    
                    <p className="text-gray-300 mb-6">
                        {isHost ? 'You are the host.' : `Host: Krittic-${currentRoom.hostId.substring(0, 4)}`}
                    </p>

                    <div className="flex items-center space-x-4 mb-8">
                        <button
                            onClick={handleLeaveRoom}
                            className={`px-6 py-3 font-bold rounded-xl shadow-lg transition transform hover:scale-105 ${
                                isHost ? 'bg-red-600 hover:bg-red-700' : 'bg-yellow-600 hover:bg-yellow-700'
                            } text-white`}
                        >
                            {isHost ? 'End Session (Delete Room)' : 'Leave Room'}
                        </button>
                        <button
                            onClick={() => setStatusMessage('Feature coming soon! This button will sync everyone to a selected movie.')}
                            className="px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition transform hover:scale-105"
                            disabled={!isHost}
                        >
                            Start Movie Sync
                        </button>
                    </div>

                    {/* Live Chat Panel */}
                    <div className="bg-gray-800 p-4 rounded-xl shadow-inner flex flex-col h-[50vh]">
                        <h3 className="text-xl font-semibold text-white mb-3 border-b border-gray-700 pb-2">
                            Live Room Chat
                        </h3>
                        <div className="flex-grow overflow-y-auto space-y-3 pb-3">
                            {messages.length === 0 && <p className="text-gray-500 text-center py-4">Start the conversation!</p>}
                            {messages.map((msg) => (
                                <div key={msg.id} className={`flex ${msg.userId === userId ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[75%] p-3 rounded-xl shadow-md ${
                                        msg.userId === userId 
                                            ? 'bg-blue-600 text-white rounded-br-none' 
                                            : 'bg-gray-700 text-gray-100 rounded-tl-none'
                                    }`}>
                                        <p className="text-xs font-bold mb-1 opacity-80">
                                            {msg.userId === userId ? 'You' : msg.userName}
                                        </p>
                                        <p>{msg.text}</p>
                                    </div>
                                </div>
                            ))}
                            <div ref={messagesEndRef} />
                        </div>
                        
                        {/* Chat Input */}
                        <form onSubmit={handleSendMessage} className="mt-4 flex space-x-2">
                            <input
                                type="text"
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                placeholder="Send a message..."
                                className="flex-grow p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition"
                                disabled={!isAuthReady}
                                maxLength={250}
                            />
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition"
                                disabled={!isAuthReady || newMessage.trim() === ''}
                            >
                                Send
                            </button>
                        </form>
                    </div>
                </div>

                {/* Column 3: Member List */}
                <div className="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-xl h-full">
                    <h3 className="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">
                        Current Friends in Room ({currentRoom.members.length})
                    </h3>
                    <div className="space-y-3 overflow-y-auto max-h-[70vh]">
                        {currentRoom.members.map(memberId => (
                            <div key={memberId} className={`p-3 rounded-lg text-gray-100 flex justify-between items-center transition ${memberId === currentRoom.hostId ? 'bg-blue-600/50 shadow-md' : 'bg-gray-700'}`}>
                                <span>
                                    {memberId === userId ? 'You (Krittic - This Device)' : `Friend Krittic-${memberId.substring(0, 4)}`}
                                </span>
                                {memberId === currentRoom.hostId && <span className="text-xs font-bold bg-white text-blue-600 px-2 py-1 rounded-full">HOST</span>}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    // --- Create/Join Initial View ---
    return (
        <div className="bg-gray-900 p-8 rounded-xl shadow-2xl min-h-[50vh] text-white">
            <button 
                onClick={() => setCurrentPage('home')}
                className="mb-6 inline-flex items-center text-blue-400 hover:text-blue-300 transition"
            >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" />
                </svg>
                Back to Home Player
            </button>
            
            <h2 className="text-4xl font-extrabold text-blue-400 mb-8 border-b-4 border-blue-700 pb-2">
                Private Social Viewing Rooms
            </h2>
            
            {/* Status Message */}
            {statusMessage && (
                <div className="p-3 mb-6 bg-red-800/50 text-red-200 border border-red-500 rounded-lg">
                    {statusMessage}
                </div>
            )}

            {/* Create Room Section */}
            <div className="mb-10 p-6 bg-gray-800 rounded-xl shadow-lg border border-blue-500/50">
                <h3 className="text-2xl font-bold mb-4 text-white">
                    1. Create a Room
                </h3>
                <p className="text-gray-400 mb-4">
                    Become the host and instantly get a unique code to share with your friends and family.
                </p>
                <button
                    onClick={handleCreateRoom}
                    className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition transform hover:scale-105"
                    disabled={!isAuthReady}
                >
                    Generate Private Room
                </button>
            </div>
            
            {/* Join Room Section */}
            <div className="p-6 bg-gray-800 rounded-xl shadow-lg">
                <h3 className="text-2xl font-bold mb-4 text-white">
                    2. Join a Friend's Room
                </h3>
                <p className="text-gray-400 mb-4">
                    Enter the code your friend shared to jump into their spoiler-free session.
                </p>
                <div className="flex space-x-3">
                    <input
                        type="text"
                        placeholder="Enter Room Code (e.g., A1B2C3)"
                        value={joinInput}
                        onChange={(e) => setJoinInput(e.target.value.toUpperCase())}
                        className="flex-grow p-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition"
                        maxLength={6}
                    />
                    <button
                        onClick={handleJoinRoom}
                        className="px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition transform hover:scale-105"
                        disabled={!isAuthReady || joinInput.length !== 6}
                    >
                        Join Room
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- Main App Component ---

const App = () => {
    const { db, auth, userId, isAuthReady } = useFirebaseInit();
    // Default to 'home', use 'private-rooms' to show the new component
    const [currentPage, setCurrentPage] = useState('home'); 

    // Display a loading state until Firebase Auth is ready and user ID is known
    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
                <p className="text-xl animate-pulse">Initializing Krittics Platform...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-950 font-sans">
            {/* Header now includes Library and the lightning bolt icon */}
            <Header currentPage={currentPage} setCurrentPage={setCurrentPage} userId={userId} />

            <main className="container mx-auto px-4 py-8">
                {currentPage === 'home' && (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Column 1 & 2: Main Content Area (Video + Live Comments) */}
                        <div className="lg:col-span-2">
                            <h2 className="text-3xl font-bold text-white mb-4">
                                Currently Watching: A Mock Film Title
                            </h2>
                            {/* Movie Embed Area */}
                            <div className="aspect-video bg-black rounded-xl shadow-2xl flex items-center justify-center mb-6">
                                <p className="text-white text-xl p-8 text-center">
                                    {/* Your movie/TV embed will go here once you add content. */}
                                    <span className="font-mono">
                                        &lt;iframe&gt;
                                    </span> Placeholder for Embeddable Movie Content (16:9)
                                </p>
                            </div>
                            
                            <p className="text-gray-400 mb-6">
                                The film has ended! Now loading the End-of-Movie Deep Dive Trivia.
                            </p>
                            
                            {/* Deep Dive Trivia Component */}
                            <TriviaGame db={db} userId={userId} isAuthReady={isAuthReady} />

                            {/* Button to navigate to Private Rooms from Home Screen */}
                            <div className="mt-8">
                                <h3 className="text-2xl font-bold text-white mb-4">
                                    Watch with Friends
                                </h3>
                                <button
                                    onClick={() => setCurrentPage('private-rooms')}
                                    className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition transform hover:scale-105"
                                >
                                    Launch Private Rooms
                                </button>
                            </div>

                        </div>

                        {/* Column 3: Spoiler-Free Social Viewing (Mockup) */}
                        <div className="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-xl">
                            <h3 className="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">
                                Spoiler-Free Live Comments
                            </h3>
                            <div className="space-y-4 h-[70vh] overflow-y-auto">
                                <div className="p-3 bg-gray-700 rounded-lg text-sm text-gray-200">
                                    <span className="font-semibold text-blue-400">[00:05:30] Krittic-JANE:</span> I love the costume design in this opening scene!
                                </div>
                                <div className="p-3 bg-gray-700 rounded-lg text-sm text-gray-200">
                                    <span className="font-semibold text-red-400">[00:22:15] Krittic-JOE:</span> Wait, I didn't catch that line! Rewind!
                                </div>
                                <div className="p-3 bg-gray-700 rounded-lg text-sm text-gray-200 opacity-50 cursor-pointer">
                                    <span className="font-semibold text-gray-500">[01:15:00] LOCKED:</span> (Comment will appear when you reach this timestamp)
                                </div>
                                <div className="p-3 bg-gray-700 rounded-lg text-sm text-gray-200 opacity-50 cursor-pointer">
                                    <span className="font-semibold text-gray-500">[01:40:05] LOCKED:</span> (Comment will appear when you reach this timestamp)
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {currentPage === 'krossfire' && (
                    <Krossfire db={db} userId={userId} isAuthReady={isAuthReady} />
                )}
                
                {/* Library Page Placeholder */}
                {currentPage === 'library' && (
                    <div className="bg-gray-900 p-8 rounded-xl shadow-2xl min-h-[80vh] text-white">
                        <h2 className="text-4xl font-extrabold text-green-400 mb-4 border-b-4 border-green-700 pb-2">
                            Your Movie Library
                        </h2>
                        <p className="text-gray-400">
                            This page is reserved for managing your personal collection of watched content.
                        </p>
                        <button 
                            onClick={() => setCurrentPage('home')}
                            className="mt-6 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition"
                        >
                            Go Back
                        </button>
                    </div>
                )}

                {/* Conditional rendering for the new PrivateRooms component */}
                {currentPage === 'private-rooms' && (
                    <PrivateRooms db={db} userId={userId} isAuthReady={isAuthReady} setCurrentPage={setCurrentPage} />
                )}
            </main>
        </div>
    );
}

export default App;
