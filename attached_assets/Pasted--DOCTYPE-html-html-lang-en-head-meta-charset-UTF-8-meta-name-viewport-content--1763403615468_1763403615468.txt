<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Movie Streaming Fixed Ads</title>

  <!-- Video.js core -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

  <!-- Google IMA SDK (for ads) -->
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

  <style>
    body { margin:0; background:#000; font-family:Arial; color:white; }
    .carousel { display:flex; overflow-x:auto; padding:20px; gap:15px; background:#111; }
    .movie-card { cursor:pointer; flex-shrink:0; width:200px; }
    .movie-card img { width:100%; border-radius:8px; }
    .movie-card p { text-align:center; margin:5px 0 0; }
    #playerContainer { position:relative; width:100vw; height:100vh; display:none; }
    #bannerAd { 
      position:fixed; bottom:0; left:0; width:100%; height:90px; 
      background:rgba(0,0,0,0.7); z-index:1000; text-align:center; 
    }
    #bannerAd img { height:90px; width:auto; }
  </style>
</head>
<body>

  <!-- Carousel -->
  <div class="carousel" id="carousel">
    <div class="movie-card" data-src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" data-title="Big Buck Bunny">
      <img src="https://peach.blender.org/wp-content/uploads/title_anouncement.jpg" alt="Big Buck Bunny">
      <p>Big Buck Bunny</p>
    </div>
    <div class="movie-card" data-src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" data-title="Elephants Dream">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Elephants_Dream_scene.jpg/800px-Elephants_Dream_scene.jpg" alt="Elephants Dream">
      <p>Elephants Dream</p>
    </div>
    <!-- Add more movies here -->
  </div>

  <!-- Fullscreen Video Player -->
  <div id="playerContainer">
    <video id="myVideo" class="video-js vjs-default-skin" controls preload="auto" width="100%" height="100%"></video>
  </div>

  <!-- Fixed Banner Ad (always visible) -->
  <div id="bannerAd">
    <!-- Example 728x90 banner - replace with your own ad tag -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3940256099942544"></script>
    <ins class="adsbygoogle"
         style="display:inline-block;width:728px;height:90px"
         data-ad-client="ca-pub-3940256099942544"
         data-ad-slot="1234567890"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

<script>
  const carousel = document.getElementById('carousel');
  const playerContainer = document.getElementById('playerContainer');
  let player, adDisplayContainer, adsLoader, adsManager;
  let currentContentSrc = '';

  // Initialize Video.js player
  const initPlayer = () => {
    player = videojs('myVideo', {
      fluid: true,
      playbackRates: [0.5, 1, 1.25, 1.5, 2]
    });

    player.ready(() => {
      player.on('play', startAdIfNeeded);
      player.on('timeupdate', checkForMidroll);
    });
  };

  // Google IMA setup
  const initAds = () => {
    adDisplayContainer = new google.ima.AdDisplayContainer(
      player.el_, player.el_
    );
    adsLoader = new google.ima.AdsLoader(adDisplayContainer);

    adsLoader.addEventListener(
      google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
      onAdsManagerLoaded,
      false
    );
    adsLoader.addEventListener(
      google.ima.AdErrorEvent.Type.AD_ERROR,
      onAdError,
      false
    );
  };

  const onAdsManagerLoaded = (adsManagerLoadedEvent) => {
    const adsRenderingSettings = new google.ima.AdsRenderingSettings();
    adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;

    adsManager = adsManagerLoadedEvent.getAdsManager(player);
    
    adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, () => {
      playerContainer.style.display = 'block';
      carousel.style.display = 'none';
      player.play();
    });

    adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, () => {
      player.play();
    });

    try {
      adsManager.init(player.width(), player.height(), google.ima.ViewMode.FULLSCREEN);
      adsManager.start();
    } catch (adError) {
      player.play();
    }
  };

  const onAdError = (adErrorEvent) => {
    console.log("Ad error:", adErrorEvent.getError());
    if (adsManager) adsManager.destroy();
    player.play();
  };

  const requestAds = (isPreroll = true) => {
    if (!adDisplayContainer.isInitialized) {
      adDisplayContainer.initialize();
    }

    const adsRequest = new google.ima.AdsRequest();
    // Replace with your real ad tag URL (VAST)
    adsRequest.adTagUrl = 'https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_ad_samples&sz=640x480&cust_params=sample_ct%3Dlinear&ciu_szs=300x250&gdfp_req=1&output=vast&unviewed_position_start=1&env=vp&impl=s&correlator=' + Date.now();

    adsRequest.linearAdSlotWidth = player.width();
    adsRequest.linearAdSlotHeight = player.height();
    adsRequest.nonLinearAdSlotWidth = player.width();
    adsRequest.nonLinearAdSlotHeight = player.height();

    adsLoader.requestAds(adsRequest);
  };

  let midrollTriggered = false;
  const checkForMidroll = () => {
    if (!midrollTriggered && player.currentTime() > player.duration() * 0.3) { // 30% mark
      midrollTriggered = true;
      player.pause();
      requestAds(false);
    }
  };

  const startAdIfNeeded = () => {
    if (!adsManager || adsManager.isCustomPlaybackUsed) return;
    requestAds(true);
  };

  // Click on carousel â†’ load movie + start pre-roll in fullscreen
  carousel.addEventListener('click', (e) => {
    const card = e.target.closest('.movie-card');
    if (!card) return;

    currentContentSrc = card.dataset.src;
    playerContainer.style.display = 'block';
    carousel.style.display = 'none';

    player.src({ type: 'video/mp4', src: currentContentSrc });
    midrollTriggered = false;

    // Initialize everything on first play
    if (!player || !adsLoader) {
      initPlayer();
      initAds();
    }

    player.ready(() => {
      player.play(); // This will trigger the pre-roll ad first
    });
  });

  // Optional: Back button inside player
  playerContainer.addEventListener('dblclick', () => {
    playerContainer.style.display = 'none';
    carousel.style.display = 'flex';
    if (adsManager) adsManager.destroy();
    player.pause();
  });

  // Start everything
  initPlayer();
  initAds();
</script>
</body>
</html>