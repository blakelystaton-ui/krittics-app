<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Continue Watching Player (Replit Ready)</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for mobile responsiveness and aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
        }
        .video-player-mock {
            background-color: #1a1a1a;
            color: white;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .video-card {
            min-width: 160px; /* fixed width for horizontal scroll */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for the horizontally scrolling section */
        .scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 12px;
            -webkit-overflow-scrolling: touch;
        }
        .scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
        <div class="text-white text-lg flex items-center space-x-2">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Connecting to Firebase...</span>
        </div>
    </div>

    <div id="app" class="max-w-4xl mx-auto space-y-8 opacity-0 transition-opacity duration-500">
        <!-- Message Box for Confirmation -->
        <div id="message-box" class="hidden fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300"></div>

        <!-- Main Video Player -->
        <div class="bg-white p-4 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">Media Player</h1>
            <div id="current-player" class="video-player-mock rounded-lg">
                Select a video below to begin playback.
            </div>
            <p class="text-sm mt-2 text-gray-600">Currently playing: <span id="current-video-title" class="font-semibold text-indigo-600">None</span></p>
        </div>

        <!-- Continue Watching Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Continue Watching (Limit: 8)</h2>
            <div id="continue-watching-list" class="scroll-container flex space-x-4 pb-2">
                <!-- Cards will be injected here via onSnapshot listener -->
                <p class="text-gray-500 italic" id="cw-placeholder">No videos watched yet.</p>
            </div>
        </div>

        <!-- Available Videos (Library Simulation) -->
        <div class="space-y-4">
            <h2 class="text-xl font-bold text-gray-800">Available Videos</h2>
            <div id="video-library-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Video selection buttons will be injected here -->
            </div>
        </div>

        <!-- Debug Information -->
        <div class="pt-6 border-t border-gray-300 text-sm text-gray-500">
            <p>User ID: <span id="user-id-display" class="font-mono text-gray-700">Loading...</span></p>
            <p>App ID: <span id="app-id-display" class="font-mono text-gray-700">Loading...</span></p>
        </div>

    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-video-player-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';

        const MAX_CONTINUE_WATCHING = 8;
        // Data path in Firestore: /artifacts/{appId}/users/{userId}/user_data/continue_watching_doc
        const CONTINUE_WATCHING_DOC_PATH = 'user_data/continue_watching_doc';

        // --- Utility Functions ---

        /**
         * Displays a temporary notification message in the message box.
         */
        const showMessage = (message, type = 'success') => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `fixed top-4 right-4 p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 ${
                type === 'success' ? 'bg-indigo-500' : 'bg-red-500'
            }`;
            box.classList.remove('hidden', 'opacity-0');
            box.classList.add('opacity-100');

            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => {
                    box.classList.add('hidden');
                }, 300);
            }, 3000);
        };


        // --- Core Video Logic ---

        /**
         * 1. Loads the selected video into the player mock.
         * 2. Calls the function to update the continue watching list in Firestore.
         * @param {string} videoId - The unique ID of the video.
         * @param {string} videoTitle - The title of the video.
         */
        window.selectVideo = async (videoId, videoTitle) => {
            if (!userId || userId === 'loading') {
                showMessage("Authentication not ready. Please wait.", 'error');
                return;
            }

            // 1. Update the Main Player UI
            const playerMock = document.getElementById('current-player');
            const titleDisplay = document.getElementById('current-video-title');
            
            // NOTE: In a real app using Cloudflare Stream or Mux, you would swap the video URL here
            playerMock.innerHTML = `Playing: ${videoTitle} (ID: ${videoId})`;
            titleDisplay.textContent = videoTitle;
            playerMock.classList.remove('bg-indigo-700');
            playerMock.classList.add('bg-indigo-600');
            
            showMessage(`Starting playback of: ${videoTitle}`);

            // 2. Update Continue Watching List (FireStore interaction)
            await saveWatchedVideo(videoId, videoTitle);
        };

        /**
         * Updates the Firestore continue watching document, enforcing the 8-item limit 
         * and moving the most recently watched video to the front.
         * @param {string} videoId - The unique ID of the video.
         * @param {string} videoTitle - The title of the video.
         */
        const saveWatchedVideo = async (videoId, videoTitle) => {
            if (!db || !userId) {
                console.error("Firestore or User ID not available.");
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${CONTINUE_WATCHING_DOC_PATH}`);
            let currentVideos = [];

            try {
                // 1. Fetch current list
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    // videos array structure: [{id: 'V001', title: '...', timestamp: 123456789}]
                    currentVideos = docSnap.data().videos || [];
                }

                const newVideo = { id: videoId, title: videoTitle, timestamp: Date.now() };

                // 2. Filter out the video if it already exists (This clears the old position)
                currentVideos = currentVideos.filter(v => v.id !== videoId);

                // 3. Prepend the new video to the front (making it the most recent watched video)
                currentVideos.unshift(newVideo);

                // 4. Enforce the 8-video limit (removes oldest items from the end)
                if (currentVideos.length > MAX_CONTINUE_WATCHING) {
                    currentVideos.splice(MAX_CONTINUE_WATCHING);
                    console.log(`CW list trimmed to ${MAX_CONTINUE_WATCHING} videos.`);
                }

                // 5. Save the updated list back to Firestore
                await setDoc(docRef, {
                    videos: currentVideos,
                    last_updated: new Date().toISOString()
                }, { merge: true });

            } catch (error) {
                console.error("Error saving watched video:", error);
                showMessage("Error saving watch history.", 'error');
            }
        };


        /**
         * Renders the continue watching list from the provided array of videos.
         */
        const renderContinueWatching = (videos) => {
            const container = document.getElementById('continue-watching-list');
            container.innerHTML = '';
            // Hide/show the placeholder message
            document.getElementById('cw-placeholder').style.display = videos.length > 0 ? 'none' : 'block';

            videos.forEach((video) => {
                const card = document.createElement('div');
                card.className = 'video-card bg-white rounded-lg shadow-md p-3 inline-block overflow-hidden h-32 flex flex-col justify-between';
                // Attach the function to play the video when clicked
                card.setAttribute('onclick', `selectVideo('${video.id}', '${video.title.replace(/'/g, "\\'")}')`); // Handle single quotes
                card.innerHTML = `
                    <div class="h-12 bg-indigo-200 rounded-md flex items-center justify-center text-sm text-indigo-800 font-semibold mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Play
                    </div>
                    <p class="text-xs font-semibold text-gray-800 whitespace-normal line-clamp-2">${video.title}</p>
                    <p class="text-xs text-gray-500 mt-1">Last Watched: ${new Date(video.timestamp).toLocaleTimeString()}</p>
                `;
                container.appendChild(card);
            });
        };


        /**
         * Sets up the real-time listener for the continue watching list.
         */
        const setupContinueWatchingListener = () => {
            if (!db || !userId) return;

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${CONTINUE_WATCHING_DOC_PATH}`);

            // onSnapshot triggers a callback function whenever the data changes in Firestore.
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().videos) {
                    const videos = docSnap.data().videos;
                    renderContinueWatching(videos);
                } else {
                    renderContinueWatching([]);
                }
            }, (error) => {
                console.error("Error setting up onSnapshot listener:", error);
                showMessage("Failed to load continue watching list.", 'error');
            });
        };


        // --- Initialization ---

        /**
         * Renders the static list of available videos in the library.
         */
        const renderVideoLibrary = () => {
            const library = [
                { id: 'V001', title: 'The Fundamentals of AI Prompting' },
                { id: 'V002', title: 'Scaling Video Delivery with Cloudflare R2' },
                { id: 'V003', title: 'Monetization Best Practices with Ad Manager' },
                { id: 'V004', title: 'Advanced Firebase Authentication Patterns' },
                { id: 'V005', title: 'Designing Mobile-First Interfaces' },
                { id: 'V006', title: 'Deploying React Apps on Replit' },
                { id: 'V007', title: 'Gemini API: Structured Output Deep Dive' },
                { id: 'V008', title: 'Introduction to Web RTC for Live Streaming' },
                { id: 'V009', title: 'Optimizing Egress Costs in the Cloud' },
                { id: 'V010', title: 'Building a Real-Time Chat System' },
            ];

            const container = document.getElementById('video-library-list');

            library.forEach(video => {
                const button = document.createElement('button');
                button.className = 'w-full text-left bg-white hover:bg-indigo-100 border border-gray-200 rounded-lg p-3 shadow transition duration-150 ease-in-out truncate';
                button.setAttribute('onclick', `selectVideo('${video.id}', '${video.title.replace(/'/g, "\\'")}')`);
                button.innerHTML = `
                    <p class="font-semibold text-gray-800 truncate">${video.title}</p>
                    <p class="text-xs text-indigo-500 mt-1">Watch Now (ID: ${video.id})</p>
                `;
                container.appendChild(button);
            });
        };

        /**
         * Initializes Firebase and authenticates the user.
         */
        const initializeAppAndAuth = async () => {
            if (!firebaseConfig) {
                document.getElementById('loading-overlay').innerHTML = '<div class="text-red-400 text-lg">Firebase Config Missing. Cannot run application.</div>';
                console.error("Firebase config is missing.");
                return;
            }

            try {
                // Initialize Firebase services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Enable Firestore logging

                // 1. Authenticate the user (using provided token or anonymously)
                let userCredential;
                if (initialAuthToken) {
                    userCredential = await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    userCredential = await signInAnonymously(auth);
                }
                userId = userCredential.user.uid;

                // 2. Update UI with user info
                document.getElementById('user-id-display').textContent = userId;
                document.getElementById('app-id-display').textContent = appId;
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app').classList.add('opacity-100');

                // 3. Setup the real-time listener and render the library
                setupContinueWatchingListener();
                renderVideoLibrary();

                showMessage("Service connected and authenticated.", 'success');

            } catch (error) {
                document.getElementById('loading-overlay').innerHTML = `<div class="text-red-400 text-lg">Authentication Error: ${error.message}</div>`;
                console.error("Firebase Initialization or Auth Failed:", error);
            }
        };

        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>