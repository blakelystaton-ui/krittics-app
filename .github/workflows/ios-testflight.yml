name: Build & Upload to TestFlight

on:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: mac-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      - name: Decode certificate and profile
        run: |
          echo "${{ secrets.CERTIFICATE_BASE64 }}" | base64 --decode > ~/certificate.p12
          echo "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/profile.mobileprovision

      - name: Install certificate and provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ~/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import ~/certificate.p12 -k build.keychain -P "" -A
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

      - name: Build iOS app with explicit config
        run: |
          cd ios/App
          xcodebuild -scheme App \
                     -configuration Release \
                     -xcconfig Capacitor.xcconfig \
                     -allowProvisioningUpdates \
                     -archivePath build/App.xcarchive \
                     archive

      - name: Export IPA
        run: |
          cd ios/App
          xcodebuild -exportArchive \
                     -archivePath build/App.xcarchive \
                     -exportOptionsPlist ExportOptions.plist \
                     -exportPath build/ipa

      - name: Upload to TestFlight
        env:
          FASTLANE_APPLE_ID: ${{ secrets.APPLE_ID_EMAIL }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          cd ios/App
          gem install fastlane
          fastlane pilot upload --ipa build/ipa/App.ipa --skip_waiting_for_build_processing true

