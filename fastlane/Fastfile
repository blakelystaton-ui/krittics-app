platform :ios do
  lane :build_capacitor do
    # This is the ONLY lane Appflow calls — everything happens here

    # 1. Force the provisioning profile on the exact target (this is the kill-shot)
    update_project_provisioning(
      xcodeproj: "ios/App/App.xcodeproj",
      target_filter: "App",
      build_configuration: "Release",
      profile: ENV["SIGH_PROFILE_PATH"] || Dir["*.mobileprovision"].first
    )

    # 2. Make absolutely sure manual signing is set
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/App/App.xcodeproj",
      targets: "App",
      team_id: "9SA2W557K5",
      code_sign_identity: "Apple Distribution: Staton Blakely (9SA2W557K5)",
      profile_name: "Krittics App Store Profile"
    )

    # 3. Direct hammer into the project file — Appflow CANNOT ignore this
    sh "sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = \"\"/PROVISIONING_PROFILE_SPECIFIER = \"Krittics App Store Profile\"/g' ios/App/App.xcodeproj/project.pbxproj"
    sh "sed -i '' 's/PROVISIONING_PROFILE = \"\"/PROVISIONING_PROFILE = \"\"/g' ios/App/App.xcodeproj/project.pbxproj || true"
  end
end
