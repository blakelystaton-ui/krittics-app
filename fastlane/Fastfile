platform :ios do
  lane :build_capacitor do
    # This lane runs automatically in Appflow — now it does EVERYTHING
    sh "echo 'FORCING SIGNING — NO ESCAPE'"

    # Force bundle ID
    update_app_identifier(
      xcodeproj: "ios/App/App.xcodeproj",
      plist_path: "ios/App/App/Info.plist",
      app_identifier: "com.blakely.krittics"
    )

    # Force team ID
    update_project_team(
      path: "ios/App/App.xcodeproj",
      teamid: "9SA2W557K5"
    )

    # Disable automatic signing + set manual
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/App/App.xcodeproj",
      team_id: "9SA2W557K5",
      code_sign_identity: "Apple Distribution: Staton Blakely (9SA2W557K5)",
      profile_name: "Krittics App Store Profile"
    )

    # FORCE the exact provisioning profile on the target (this is the kill shot)
    update_project_provisioning(
      xcodeproj: "ios/App/App.xcodeproj",
      profile: ENV["SIGH_PROFILE_PATH"],
      target_filter: "App",
      build_configuration: "Release"
    )

    # Double-tap: set PROVISIONING_PROFILE_SPECIFIER directly
    sh "plutil -replace PROVISIONING_PROFILE_SPECIFIER -string 'Krittics App Store Profile' ios/App/App/Info.plist"
    sh "plutil -replace CODE_SIGN_IDENTITY -string 'Apple Distribution: Staton Blakely (9SA2W557K5)' ios/App/App/Info.plist"

    sh "echo 'SIGNING FORCED — BUILD WILL SUCCEED'"
  end
end
